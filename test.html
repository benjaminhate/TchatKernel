<!DOCTYPE html>
<html>
<head>
	<title>Test 2 WebRTC</title>	
</head>

<body>

<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script src="node_modules/lodash/lodash.js"></script>
<script src="node_modules/node-uuid/uuid.js"></script>
<script src="./Events.js"></script>

<script type="text/javascript">
	var http = new XMLHttpRequest();
	var connectedPeers={};
	var ID;
	var Communautes=[];
	var Messages=[];
	var limite = 200;

	function Tchat(){}

	Tchat.prototype = Object.create(window.EventEmitter.prototype);

	function Message(dest,msg,sender){
		this.destination=dest;
		this.msg=msg;
		this.sender=sender;
		this.time=Date.now();
		this.signature=uuid.v4(this);
		return this
	}

	Message.prototype=Object.create(window.Object.prototype);

	var peer = new Peer({host:'192.168.1.102',port:8080});
	peer.on('open',function(id){
		console.log('My peer ID is: ' + id);
		ID = id;
	});

	peer.on('connection',connect);

	var tchat = new Tchat();

	setInterval(connected,1000);

	setInterval(GroupList,2000);

	function connected(){
		Communautes.forEach((el)=>{if(el.connectes.length<limite) Send(el.name,'636f6e6e656374e9')});
	}

	function GroupList(){
		Communautes.forEach((communaute)=>{
			if(communaute.connectes.length<limite){
				tchat.emit(communaute.name,communaute.connectes);
			}else{
				tchat.emit(communaute.name,'Groupe trop grand');
			}
		});
	}

	function connect(c){
		c.on('data',function(data){
			if(data.destination.charAt(0)=='#'){
				if(data.msg=='636f6e6e656374e9'){
					var group=_.find(Communautes,(el)=>el.name==data.destination);
					if(group && !_.find(group.connectes,(el)=>el==data.sender)){
						group.connectes.push(data.sender);
					}
				}else{console.log('message reçu de',c.peer,':',data);}
					
				var M = Messages.find((el)=>el.id==data.destination);
				if(M){
					var m = M.msgs.find((el)=>_.isEqual(el,data));
					if(!m){
						_.forEach(peer.connections,(el)=>el[0].send(data));
						M.addMessage(data);
					}
				}else{
					_.forEach(peer.connections,(el)=>el[0].send(data));
					var group = new Group(data.destination);
					group.addMessage(data);
					Messages.push(group);
				}
			}else{
				console.log('message reçu de',c.peer,':',data);
			}
			tchat.emit('message',data);
		});
		c.on('close',function(){
			console.log('connection fermée avec',c.peer);
			tchat.emit('deconnection','@'+c.peer);
			Communautes.forEach(group => { _.remove(group.connectes, el=>el==c.peer)});
			delete connectedPeers[c.peer];
		});
		connectedPeers[c.peer]=1;
	}

	function Open(name){
		if(name.charAt(0)=='@') name = name.replace('@','');
		if(name.charAt(0)=='#'){
			name = name.toLowerCase();
			Communautes.push({name:name,connectes:[]});
			name = name.replace('#','%23');
			http.open('GET','/send/'+name+'/'+ID);
			http.send();
			http.onload = function(){
				var Clients=JSON.parse(http.response);
				var i=0;
				var Connections=[];
				for(key in connectedPeers){
					Connections.push(key);

				}
				var Diff = _.difference(Clients,Connections,[ID]);
				if(Diff.length>=2){
					while(i!=2){
						var random = Math.round(Math.random()*(Clients.length-1));
						if(ID!=Clients[random] && !connectedPeers[Clients[random]]){
							Open('@'+Clients[random]);
							i++;
						}
					}
				}
				if(Diff.length==1){
					Open('@'+Diff[0]);
				}
				
			}
		};
		if(!connectedPeers[name]){
			var c=peer.connect(name);
			c.on('open', function() {
				console.log('connection ouverte avec',name);
				tchat.emit('connection','@'+name);
				connect(c);

				c.on('error',function(err){
					console.log(err);
				});

			});
			connectedPeers[name]=1;
		}
	}

	function Send(name,message){
		var msg = new Message(name,message,ID);
		if(name.charAt(0)=='@'){
			name = name.replace('@','');
			var connections = peer.connections[name];
			if(connections){
				connections[0].send(msg);
				if(message!='636f6e6e656374e9'){
					console.log('message envoyé à',name,':',msg);
					var M = Messages.find((el)=>el.id==name);
					if(!M){
						var group = new Group(name);
						group.addMessage(msg);
						Messages.push(group);
					}else{
						M.addMessage(msg);
					}
				}
			}else{
				Open('@'+name);
				console.log("La connection n'est pas encore ouverte, veuillez réessayer plus tard");
			}
		}

		if(name.charAt(0)=='#'){
			var group = _.find(Communautes,(el)=>el.name==name);
			if(group){
				_.forEach(peer.connections,(el)=>{if(el[0].open) el[0].send(msg)});
				if(message!='636f6e6e656374e9'){
					console.log('message envoyé à',name,':',msg);
					var M = Messages.find((el)=>el.id==name);
					if(!M){
						var group = new Group(name);
						group.addMessage(msg);
						Messages.push(group);
					}else{
						M.addMessage(msg);
					}
				}
			}else{
				Open(name);
				console.log("La connection n'est pas encore ouverte, veuillez réessayer plus tard");
			}
		}

	}

	function Group(name){
		this.id=name;
		this.msgs=[];
	}
	Group.prototype.addMessage=function(msg){
		this.msgs.push(msg);
	};

	window.onunload = window.onbeforeunload = function(e) {
			if (!!peer && !peer.destroyed) {
				peer.destroy();
			}
		};
</script>

</body>
</html>